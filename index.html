<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>CartoGraph</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" type="text/css" href="coolmap.css">
  <link href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css" rel="stylesheet" />
  <script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>
</head>

<body>
  <div id="map"></div>
  <div class="theme-switcher">
    <div class="search-container" id="search-container" aria-haspopup="listbox">
      <input id="global-search" class="search-input" type="search" placeholder="Search places, rivers, seas, lakes..."
        autocomplete="off" />
      <div id="search-results" class="search-results" role="listbox"></div>
    </div>
    <button id="camera-toggle" onclick="toggleCameraMovement()" style="background: rgba(255,150,150,0.2);">
      ğŸ¥ Camera: ON
    </button>
    <button onclick="setTheme('light')">Light</button>
    <button onclick="setTheme('paper')">Paper</button>
    <button onclick="resetMap()" style="margin-left: 12px; background: rgba(255,100,100,0.2);">ğŸŒ Reset View</button>
    <button id="zoom-toggle" onclick="toggleZoom()" style="background: rgba(100,255,100,0.2);">ğŸ” Zoom: ON</button>
  </div>
  <div class="timeline-controls">
    <input type="text" id="month-input" class="date-input" placeholder="MM" value="1" />
    <span style="color:white; font-weight:bold;">/</span>
    <input type="text" id="day-input" class="date-input" placeholder="DD" value="26" />
    <button id="fetch-history-btn" class="fetch-btn" onclick="fetchHistory()">Go</button>
    <div id="history-loading" class="loading-indicator"></div>
  </div>
  <div class="timeline-container">
    <label for="timeline-slider">Year: <span id="current-year">0</span></label>
    <input type="range" id="timeline-slider" min="-3000" max="2025" value="0" step="1">
  </div>
  <div id="info" class="info-card"></div>
  <div id="sidebar" class="sidebar">
    <div class="sidebar-hero">
      <img id="sidebar-hero-img" class="sidebar-hero-img" src="" alt="Hero" />
      <div class="sidebar-hero-overlay">
        <h2 id="sidebar-title" class="sidebar-title"></h2>
      </div>
      <button class="sidebar-close" onclick="closeSidebar()">Ã—</button>
    </div>

    <div id="sidebar-stats" class="sidebar-stats"></div>

    <div class="sidebar-content">
      <div class="content-section">
        <h3 class="section-title">Historical Overview</h3>
        <p id="sidebar-description" class="section-text"></p>
      </div>

    </div>

    <div class="sidebar-footer">
      <button class="footer-btn primary" onclick="openWikipediaPage()">
        <span>ğŸŒ</span> Explore on Wikipedia
      </button>
      <button class="footer-btn" onclick="shareLocation()">
        <span>ğŸ”—</span> Share
      </button>
    </div>
  </div>

  <!--<script src="coolmap.js"></script>-->
  <script src="map-core.js"></script>
  <script src="data-service.js"></script>
  <script src="map-layers.js"></script>
  <script src="timeline.js"></script>
  <script src="mock-data.js"></script>
  <script src="map-interactions.js"></script>
  <script src="map-search.js"></script>
  <script src="historical-events.js"></script>
  <script src="map-history.js"></script>
  <script>
    async function fetchHistory() {
      const month = document.getElementById('month-input').value;
      const day = document.getElementById('day-input').value;
      const btn = document.getElementById('fetch-history-btn');
      const loader = document.getElementById('history-loading');

      btn.style.display = 'none';
      loader.style.display = 'block';

      try {
        const events = await historicalEventService.fetchEvents(month, day);
        console.log(`Fetched ${events.length} events for ${month}/${day}`);

        // Store in timeline engine for filtering
        timelineEngine.loadedEvents = events;

        if (events.length === 0) {
          alert(`No events found for ${month}/${day}. Try a major date (e.g., 1/1, 7/4) or check console for errors.`);
        } else {
          // Trigger update for current slider year
          mapHistoryLayer.updateYear(timelineEngine.currentYear, events);

          // Feedback toast
          const btn = document.getElementById('fetch-history-btn');
          const originalText = btn.textContent;
          btn.textContent = `âœ“ ${events.length}`;
          setTimeout(() => { btn.textContent = originalText; }, 2000);
        }
      } catch (e) {
        console.error(e);
        alert('Failed to fetch history');
      } finally {
        btn.style.display = 'block';
        loader.style.display = 'none';
      }
    }
  </script>
</body>

</html>